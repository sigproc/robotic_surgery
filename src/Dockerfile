FROM sigproc/ros:hydro

MAINTAINER Rich Wareham <rjw57@cam.ac.uk>

# As root...
USER root

# Add ssh's required directory
RUN mkdir /var/run/sshd

# Default command is to run a ssh daemon in the container
CMD ["/usr/sbin/sshd", "-D"]

# Needed since UTF8 locales are not generated by default in Ubuntu precise
RUN locale-gen en_GB.UTF-8

# Set password for ros and add to sudoers
RUN echo 'ros:ros' | chpasswd
RUN usermod -a -G sudo ros

# Add a PPA for OpenRave. (See http://moveit.ros.org/wiki/Kinematics/IKFast)
RUN add-apt-repository ppa:openrave/release

# Make sure package sources are up to date
RUN apt-get -y update

# Install additional packages
RUN apt-get -y install ros-hydro-moveit-full \
    ros-hydro-dynamixel-motor ros-hydro-dynamixel-controllers \
    ros-hydro-ivcon ros-hydro-convex-decomposition \
    gazebo ros-hydro-gazebo-ros \
    lubuntu-core lxterminal openssh-server xserver-xephyr \
    openrave0.8-dp-plugin-oderave openrave0.8-dp-plugin-textserver
RUN apt-get -y install gtk2-engines gtk2-engines-pixbuf
RUN apt-get -y install x11vnc
RUN apt-get -y install xserver-xorg-video-dummy xserver-xorg-input-void
RUN apt-get -y install xvfb

# USB webcam support
RUN apt-get -y install ros-hydro-usb-cam

# Install OpenCV libraries and the Python bindings
RUN apt-get -y install libopencv-dev python-opencv

# JsonCPP library for k2_client
RUN apt-get -y install libjsoncpp-dev

# Comment out annoying line which stops .bashrc from sourcing for
# non-interactive shells.
RUN sed -i 's/\[ -z "$PS1" \] && return/# &/' /home/ros/.bashrc 

# Allow ros user to start the X server
RUN sed -i 's/allowed_users=console/allowed_users=anybody/' /etc/X11/Xwrapper.config

# Add ros user to video group so that they can access the video card directly and the
# dialout group so that they can access the serial port.
RUN usermod -a -G video,dialout ros

# Copy ssh config
ADD config/ssh /home/ros/.ssh
RUN chown -R ros:ros /home/ros/.ssh
RUN chmod -R og-rwx /home/ros/.ssh

# Copy autostart config
ADD config/autostart /home/ros/.config/autostart
RUN chown -R ros:ros /home/ros/.config/autostart

# Copy X config
ADD config/X11 /etc/X11

# Copy local executables
ADD config/bin/Xdummy /usr/bin/

# Copy ROS source code to ROS workspace
ADD ./ros /home/ros/workspace/src/robotic_surgery
RUN chown -R ros:ros /home/ros/workspace/src/robotic_surgery
